# Encrypt managed disks with cross-tenant customer-managed keys

* Article
* 03/10/2023
* 4 contributors

Feedback

## In this article

This article covers building a solution where you encrypt managed disks with customer-managed keys using Azure Key Vaults stored in a different Azure Active Directory (Azure AD) tenant. This configuration can be ideal for several scenarios, one example being Azure support for service providers that want to offer bring-your-own encryption keys to their customers where resources from the service provider's tenant are encrypted with keys from their customer's tenant.

A disk encryption set with federated identity in a cross-tenant CMK workflow spans service provider/ISV tenant resources (disk encryption set, managed identities, and app registrations) and customer tenant resources (enterprise apps, user role assignments, and key vault). In this case, the source Azure resource is the service provider's disk encryption set.

If you have questions about cross-tenant customer-managed keys with managed disks, email [crosstenantcmkvteam@service.microsoft.com](mailto:crosstenantcmkvteam@service.microsoft.com).

## Limitations

* Managed Disks and the customer's Key Vault must be in the same Azure region, but they can be in different subscriptions.
* This feature doesn't support Ultra Disks or Azure Premium SSD v2 managed disks.
* This feature isn't available in Azure China or Government clouds.

## About cross-tenant customer-managed keys

Many service providers building Software as a Service (SaaS) offerings on Azure want to offer their customers the option to manage their own encryption keys. Customer-managed keys allow a service provider to encrypt the customer's data using an encryption key that is managed by the service provider's customer and that is not accessible to the service provider. In Azure, the service provider's customer can use Azure Key Vault to manage their encryption keys in their own Azure AD tenant and subscription.

Azure platform services and resources that are owned by the service provider and that reside in the service provider's tenant require access to the key from the customer's tenant to perform the encryption/decryption operations.

The image below shows a data encryption at rest with federated identity in a cross-tenant CMK workflow spanning a service provider and its customer.

[![Screenshot showing a cross-tenant CMK with a federated identity.](../includes/media/active-directory-msi-cross-tenant-cmk-overview/cross-tenant-cmk.png)](../includes/media/active-directory-msi-cross-tenant-cmk-overview/cross-tenant-cmk.png#lightbox)

In the example above, there are two Azure AD tenants: an independent service provider's tenant (*Tenant1*), and a customer's tenant (*Tenant2*). *Tenant1* hosts Azure platform services and *Tenant2* hosts the customer's key vault.

A multi-tenant application registration is created by the service provider in *Tenant1*. A [federated identity credential](../active-directory/develop/workload-identity-federation-create-trust) is created on this application using a user-assigned managed identity. Then, the name and application ID of the app is shared with the customer.

A user with the appropriate permissions installs the service provider's application in the customer tenant, *Tenant2*. A user then grants the service principal associated with the installed application access to the customer's key vault. The customer also stores the encryption key, or customer-managed key, in the key vault. The customer shares the key location (the URL of the key) with the service provider.

The service provider now has:

* An application ID for a multi-tenant application installed in the customer's tenant, which has been granted access to the customer-managed key.
* A managed identity configured as the credential on the multi-tenant application.
* The location of the key in the customer's key vault.

With these three parameters, the service provider provisions Azure resources in *Tenant1* that can be encrypted with the customer-managed key in *Tenant2*.

Let's divide the above end-to-end solution into three phases:

1. The service provider configures identities.
2. The customer grants the service provider's multi-tenant app access to an encryption key in Azure Key Vault.
3. The service provider encrypts data in an Azure resource using the CMK.

Operations in Phase 1 would be a one-time setup for most service provider applications. Operations in Phases 2 and 3 would repeat for each customer.

### Phase 1 - The service provider configures an Azure AD application

| Step | Description | Minimum role in Azure RBAC | Minimum role in Azure AD RBAC |
| --- | --- | --- | --- |
| 1. | Create a new multi-tenant Azure AD application registration or start with an existing application registration. Note the application ID (client ID) of the application registration using [Azure portal](../active-directory/develop/quickstart-register-app), [Microsoft Graph API](/en-us/graph/api/application-post-applications), [Azure PowerShell](/en-us/powershell/module/azuread/new-azureadapplication), or [Azure CLI](/en-us/cli/azure/ad/app#az_ad_app_create) | None | [Application Developer](../active-directory/roles/permissions-reference#application-developer) |
| 2. | Create a user-assigned managed identity (to be used as a Federated Identity Credential).  [Azure portal](../active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp&preserve-view=true) / [Azure CLI](../active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azcli&preserve-view=true) / [Azure PowerShell](../active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-powershell&preserve-view=true)/ [Azure Resource Manager Templates](../active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-arm&preserve-view=true) | [Manage identity contributor](../role-based-access-control/built-in-roles?preserve-view=true#managed-identity-contributor) | None |
| 3. | Configure user-assigned managed identity as a *federated identity credential* on the application, so that it can impersonate the identity of the application.  [Graph API reference](https://aka.ms/fedcredentialapi)/ [Azure portal](../active-directory/develop/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azp)/ [Azure CLI](../active-directory/develop/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azcli)/ [Azure PowerShell](../active-directory/develop/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-powershell) | None | Owner of the application |
| 4. | Share the application name and application ID with the customer, so that they can install and authorize the application. | None | None |

#### Considerations for service providers

* Azure Resource Manager (ARM) templates are not recommended for creating Azure AD applications.
* The same multi-tenant application can be used to access keys in any number of tenants, like *Tenant2*, *Tenant3*, *Tenant4*, and so on. In each tenant, an independent instance of the application is created that has the same application ID but a different object ID. Each instance of this application is thus authorized independently. Consider how the application object used for this feature is used to partition your application across all customers.
	+ Application can have a maximum of 20 federated identity credentials, which requires a service provider to share federated identities among its customers. For more information about federated identities design considerations and restrictions, see [Configure an app to trust an external identity provider](../active-directory/develop/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azp#important-considerations-and-restrictions)
* In rare scenarios, a service provider may use a single Application object per its customer, but that will require significant maintenance costs to manage applications at scale across all customers.
* In the service provider tenant, it is not possible to automate the [Publisher Verification](../active-directory/develop/publisher-verification-overview).

### Phase 2 - The customer authorizes access to the key vault

| Step | Description | Least privileged Azure RBAC roles | Least privileged Azure AD roles |
| --- | --- | --- | --- |
| 1. | - *Recommended*: Send the user to [sign in](../active-directory/develop/scenario-web-app-sign-user-overview?tabs=aspnetcore) to your app. If the user can sign in, then a service principal for your app exists in their tenant.
- Use [Microsoft Graph](/en-us/graph/api/serviceprincipal-post-serviceprincipals), [Microsoft Graph PowerShell](/en-us/powershell/module/microsoft.graph.applications/new-mgserviceprincipal?view=graph-powershell-beta&preserve-view=true), [Azure PowerShell](/en-us/powershell/module/az.resources/new-azadserviceprincipal), or [Azure CLI](/en-us/cli/azure/ad/sp#az-ad-sp-create) to create the service principal.
- Construct [an admin-consent URL](../active-directory/manage-apps/grant-admin-consent#construct-the-url-for-granting-tenant-wide-admin-consent) and grant tenant-wide consent to create the service principal using the application ID.
 | None | Users with permissions to install applications |
| 2. | Create an Azure Key Vault and a key used as the customer-managed key. | A user must be assigned the [Key Vault Contributor](../role-based-access-control/built-in-roles#key-vault-contributor) role to create the key vault | None |
| 3. | Grant the consented application identity access to the Azure key vault by assigning the role [Key Vault Crypto Service Encryption User](../key-vault/general/rbac-guide?preserve-view=true&tabs=azure-cli#azure-built-in-roles-for-key-vault-data-plane-operations) | To assign the **Key Vault Crypto Service Encryption User** role to the application, you must have been assigned the [User Access Administrator](../role-based-access-control/built-in-roles#user-access-administrator) role. | None |
| 4. | Copy the key vault URL and key name into the customer-managed keys configuration of the SaaS offering. | None | None |

#### Considerations for customers of service providers

* In the customer tenant, *Tenant2*, an admin can set policies to block non-admin users from installing applications. These policies can prevent non-admin users from creating service principals. If such a policy is configured, then users with permissions to create service principals will need to be involved.
* Access to Azure Key Vault can be authorized using Azure RBAC or access policies. When granting access to a key vault, make sure to use the active mechanism for your key vault.
* An Azure AD application registration has an application ID (client ID). When the application is installed in your tenant, a service principal is created. The service principal shares the same application ID as the app registration, but generates its own object ID. When you authorize the application to have access to resources, you may need to use the service principal `Name` or `ObjectID` property.

### Phase 3 - The service provider encrypts data in an Azure resource using the customer-managed key

After phase 1 and 2 are complete, the service provider can configure encryption on the Azure resource with the key and key vault in the customer's tenant and the Azure resource in the ISV's tenant. The service provider can configure cross-tenant customer-managed keys with the client tools supported by that Azure resource, with an ARM template, or with the REST API.

## Configure cross-tenant customer-managed keys

This section describes how to configure a cross-tenant customer-managed key (CMK) and encrypt customer data. You learn how to encrypt customer data in a resource in *Tenant1* using a CMK stored in a key vault in *Tenant2*. You can use the Azure portal, Azure PowerShell, or Azure CLI.

* [Portal](#tabpanel_1_azure-portal)
* [PowerShell](#tabpanel_1_azure-powershell)
* [Azure CLI](#tabpanel_1_azure-cli)

Sign in to the [Azure portal](https://portal.azure.com) and follow these steps.

### The service provider configures identities

The following steps are performed by the service provider in the service provider's tenant *Tenant1*.

#### The service provider creates a new multi-tenant app registration

You can either create a new multi-tenant Azure AD application registration or start with an existing multi-tenant application registration. If starting with an existing application registration, note the application ID (client ID) of the application.

To create a new registration:

1. Search for **Azure Active Directory** in the search box. Locate and select the **Azure Active Directory** extension.
2. Select **Manage > App registrations** from the left pane.
3. Select **+ New registration**.
4. Provide the name for the application registration and select *Account in any organizational directory (Any Azure AD directory â Multitenant)*.
5. Select **Register**.
6. Note the **ApplicationId/ClientId** of the application.

[![Screen shot showing how to create a new multi-tenant application registration.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/register-application.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/register-application.png#lightbox)

#### The service provider creates a user-assigned managed identity

Create a user-assigned managed identity to be used as a federated identity credential.

1. Search for **Managed Identities** in the search box. Locate and select the **Managed Identities** extension.
2. Select **+ Create**.
3. Provide the resource group, region, and name for the managed identity.
4. Select **Review + create**.
5. On successful deployment, note the **Azure ResourceId** of the user-assigned managed identity, which is available under **Properties**. For example:

`/subscriptions/tttttttt-0000-tttt-0000-tttt0000tttt/resourcegroups/XTCMKDemo/providers/Microsoft.ManagedIdentity/userAssignedIdentities/ConsotoCMKDemoUA`

[![Screen shot showing how to create a resource group and a user-assigned managed identity.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/create-user-assigned-managed-identity.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/create-user-assigned-managed-identity.png#lightbox)

#### The service provider configures the user-assigned managed identity as a federated credential on the application

Configure a user-assigned managed identity as a federated identity credential on the application, so that it can impersonate the identity of the application.

1. Navigate to **Azure Active Directory > App registrations > your application**.
2. Select **Certificates & secrets**.
3. Select **Federated credentials**.

[![Screen shot showing how to navigate to Certificate and secrets.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/certificates-secrets.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/certificates-secrets.png#lightbox)
4. Select **+ Add credential**.
5. Under **Federated credential scenario**, select **Customer Managed Keys**.
6. Click **Select a managed identity**. From the pane, select the subscription. Under **Managed identity**, select **User-assigned managed identity**. In the **Select** box, search for the managed identity you created earlier, then click **Select** at the bottom of the pane.

[![Screen shot showing how to select a managed identity.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/select-managed-identity.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/select-managed-identity.png#lightbox)
7. Under **Credential details**, provide a name and optional description for the credential and select **Add**.

[![Screen shot showing how to add a credential.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/add-credential.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/add-credential.png#lightbox)

To use Azure PowerShell to configure the ISV's tenant, install the latest [Az](https://www.powershellgallery.com/packages/Az) module. For more information about installing PowerShell, see [Install Azure PowerShell on Windows with PowerShellGet](/en-us/powershell/azure/install-azure-powershell).

* If you choose to use Azure PowerShell locally:
	+ [Install the Az PowerShell module](/en-us/powershell/azure/install-azure-powershell).
	+ Connect to your Azure account using the
	[Connect-AzAccount](/en-us/powershell/module/az.accounts/connect-azaccount) cmdlet.
* If you choose to use Azure Cloud Shell:
	+ See [Overview of Azure Cloud Shell](../cloud-shell/overview) for more information.

### The service provider configures identities

The following steps are performed by the service provider (ISV) in the service provider's tenant, *Tenant1*.

#### The service provider signs into Azure

In Azure PowerShell, sign in to the ISV's tenant and set the active subscription to the ISV's subscription.

```
$isvTenantId="<isv-tenant-id>"
$isvSubscriptionId="<isv-subscription-id>"

# Sign in to Azure in the ISV's tenant.
Connect-AzAccount -Tenant $isvTenantId
# Set the context to the ISV's subscription.
Set-AzContext -Subscription $isvSubscriptionId

```

#### The service provider creates a new multi-tenant app registration

Pick a name for your multi-tenant registered application in *Tenant1*, and create the multi-tenant application in the Azure portal.

The name that you provide for the multi-tenant application is used by the customer to identify the application in *Tenant2*. Note the app's object ID and application ID. You'll need these values in subsequent steps.

```
$multiTenantAppName="<multi-tenant-app>"
$multiTenantApp = New-AzADApplication -DisplayName $multiTenantAppName `
    -SignInAudience AzureADMultipleOrgs

# Object ID for the new multi-tenant app
$objectId = $multiTenantApp.Id
# Application (client) ID for the multi-tenant app
$multiTenantAppObjectId = $multiTenantApp.AppId

```

#### The service provider creates a user-assigned managed identity

Sign in to the ISV's tenant, and then create a user-assigned managed identity to be used as a federated identity credential. To create a new user-assigned managed identity, you must be assigned a role that includes the **Microsoft.ManagedIdentity/userAssignedIdentities/write** action.

```
$isvRgName="<isv-resource-group>"
$isvLocation="<location>"
$userIdentityName="<user-assigned-managed-identity>"

# Create a new resource group in the ISV's subscription.
New-AzResourceGroup -Location $isvLocation -ResourceGroupName $isvRgName

# Create the new user-assigned managed identity.
$userIdentity = New-AzUserAssignedIdentity -Name $userIdentityName `
    -ResourceGroupName $isvRgName `
    -Location $isvLocation `
    -SubscriptionId $isvSubscriptionId

```

#### The service provider configures the user-assigned managed identity as a federated credential on the application

Configure a user-assigned managed identity as a federated identity credential on the application, so that it can impersonate the identity of the application.

To configure the federated identity credential from PowerShell, first install version 6.3.0 or later of the [Az.Resources](https://www.powershellgallery.com/packages/Az.Resources) module.

```
New-AzADAppFederatedCredential -ApplicationObjectId $multiTenantApp.Id `
    -Name "MyFederatedIdentityCredential" `
    -Audience "api://AzureADTokenExchange" `
    -Issuer "https://login.microsoftonline.com/<tenant-id>/v2.0" `
    -Subject $userIdentity.PrincipalId `
    -Description "Federated Identity Credential for CMK"

```

* Use the Bash environment in [Azure Cloud Shell](/en-us/azure/cloud-shell/overview). For more information, see [Quickstart for Bash in Azure Cloud Shell](/en-us/azure/cloud-shell/quickstart).

[![](../reusable-content/azure-cli/media/hdi-launch-cloud-shell.png)](https://shell.azure.com)
* If you prefer to run CLI reference commands locally, [install](/en-us/cli/azure/install-azure-cli) the Azure CLI. If you're running on Windows or macOS, consider running Azure CLI in a Docker container. For more information, see [How to run the Azure CLI in a Docker container](/en-us/cli/azure/run-azure-cli-docker).

	+ If you're using a local installation, sign in to the Azure CLI by using the [az login](/en-us/cli/azure/reference-index#az-login) command. To finish the authentication process, follow the steps displayed in your terminal. For other sign-in options, see [Sign in with the Azure CLI](/en-us/cli/azure/authenticate-azure-cli).
	+ When you're prompted, install the Azure CLI extension on first use. For more information about extensions, see [Use extensions with the Azure CLI](/en-us/cli/azure/azure-cli-extensions-overview).
	+ Run [az version](/en-us/cli/azure/reference-index?#az-version) to find the version and dependent libraries that are installed. To upgrade to the latest version, run [az upgrade](/en-us/cli/azure/reference-index?#az-upgrade).

### The service provider configures identities

The following steps are performed by the service provider in the service provider's tenant *Tenant1*.

#### The service provider signs in to Azure

Sign in to Azure to use Azure CLI.

```
az login

```

#### The service provider creates a new multi-tenant app registration

Pick a name for your multi-tenant application in *Tenant1*, and create the multi-tenant application in the Azure portal.

The name that you provide for the multi-tenant application is used by the customer to identify the application in *Tenant2*. Copy the application ID (or client ID) of the app, the object ID of the app, and also the tenant ID for the app. You'll need these values in the following steps.

```
multiTenantAppName="<multi-tenant-app>"
multiTenantAppObjectId=$(az ad app create --display-name $multiTenantAppName \
    --sign-in-audience AzureADMultipleOrgs \
    --query id \
    --output tsv)

multiTenantAppId=$(az ad app show --id $multiTenantAppObjectId --query appId --output tsv)

```

#### The service provider creates a user-assigned managed identity

Sign in to the ISV's tenant, and then create a user-assigned managed identity to be used as a federated identity credential. To create a new user-assigned managed identity, you must be assigned a role that includes the **Microsoft.ManagedIdentity/userAssignedIdentities/write** action.

```
isvSubscriptionId="<isv-subscription-id>"
isvRgName="<isv-resource-group>"
isvLocation="<location>"
userIdentityName="<user-assigned-managed-identity>"

az group create --location $isvLocation \
    --resource-group $isvRgName \
    --subscription $isvSubscriptionId

principalId=$(az identity create --name $userIdentityName \
    --resource-group $isvRgName \
    --location $isvLocation \
    --subscription $isvSubscriptionId \
    --query principalId \
    --out tsv)

```

#### The service provider configures the user-assigned managed identity as a federated credential on the application

Run the [az ad app federated-credential create](/en-us/cli/azure/ad/app/federated-credential#az-ad-app-federated-credential-create) method to configure a federated identity credential on an app and create a trust relationship with an external identity provider.

Use `api://AzureADTokenExchange` as the `audience` value in the federated identity credential. See the [API reference](https://aka.ms/fedcredentialapi) for more details.

```
# Create a file named "credential.json" with the following content.
# Replace placeholders in angle brackets with your own values.
{
    "name": "MyFederatedIdentityCredential",
    "issuer": "https://login.microsoftonline.com/<tenantID>/v2.0",
    "subject": "<user-assigned-identity-principal-id>",
    "description": "Federated Identity Credential for CMK",
    "audiences": [
        "api://AzureADTokenExchange"
    ]
}

az ad app federated-credential create --id $multiTenantAppObjectId --parameters credential.json

```

#### The service provider shares the application ID with the customer

Find the application ID (client ID) of the multi-tenant application and share it with the customer.

### The customer grants the service provider's app access to the key in the key vault

The following steps are performed by the customer in the customer's tenant *Tenant2*. The customer can use the Azure portal, Azure PowerShell, or Azure CLI.

The user executing the steps must be an administrator with a privileged role such as [Application Administrator](../active-directory/roles/permissions-reference#application-administrator), [Cloud Application Administrator](../active-directory/roles/permissions-reference#cloud-application-administrator), or [Global Administrator](../active-directory/roles/permissions-reference#global-administrator).

* [Portal](#tabpanel_2_azure-portal)
* [PowerShell](#tabpanel_2_azure-powershell)
* [Azure CLI](#tabpanel_2_azure-cli)

Sign in to the [Azure portal](https://portal.azure.com) and follow these steps.

#### The customer installs the service provider application in the customer tenant

To install the service provider's registered application in the customer's tenant, you create a service principal with the application ID from the registered app. You can create the service principal in either of the following ways:

* Use [Microsoft Graph](/en-us/graph/api/serviceprincipal-post-serviceprincipals), [Microsoft Graph PowerShell](/en-us/powershell/module/microsoft.graph.applications/new-mgserviceprincipal?view=graph-powershell-beta&preserve-view=true), [Azure PowerShell](/en-us/powershell/module/az.resources/new-azadserviceprincipal), or [Azure CLI](/en-us/cli/azure/ad/sp#az-ad-sp-create) to manually create the service principal.
* Construct an [admin-consent URL](../active-directory/manage-apps/grant-admin-consent#construct-the-url-for-granting-tenant-wide-admin-consent) and grant tenant-wide consent to create the service principal. You'll need to provide them with your AppId.

#### The customer creates a key vault

To create the key vault, the user's account must be assigned the **Key Vault Contributor** role or another role that permits creation of a key vault.

1. From the Azure portal menu, or from the Home page, select **+ Create a resource**. In the Search box, enter **Key vaults**. From the results list, select **Key vaults**. On the **Key vaults** page, select **Create**.
2. On the **Basics** tab, choose a subscription. Under **Resource group**, select **Create new** and enter a resource group name.
3. Enter a unique name for the key vault.
4. Select a region and pricing tier.
5. Enable purge protection for the new key vault.
6. On the **Access policy** tab, select **Azure role-based access control** for **Permission model**.
7. Select **Review + create** and then **Create**.

[![Screen shot showing how to create a key vault.](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/create-key-vault.png)](../includes/media/active-directory-msi-cross-tenant-cmk-create-identities-authorize-key-vault/create-key-vault.png#lightbox)

Take note of the key vault name and URI Applications that access your key vault must use this URI.

For more information, see [Quickstart - Create an Azure Key Vault with the Azure portal](../key-vault/general/quick-create-portal).

#### The customer assigns Key Vault Crypto Officer role to a user account

This step ensures that you can create encryption keys.

1. Navigate to your key vault and select **Access Control (IAM)** from the left pane.
2. Under **Grant access to this resource**, select **Add role assignment**.
3. Search for and select **Key Vault Crypto Officer**.
4. Under **Members**, select **User, group, or service principal**.
5. Select **Members** and search for your user account.
6. Select **Review + Assign**.

#### The customer creates an encryption key

To create the encryption key, the user's account must be assigned the **Key Vault Crypto Officer** role or another role that permits creation of a key.

1. On the Key Vault properties page, select **Keys**.
2. Select **Generate/Import**.
3. On the **Create a key** screen, specify a name for the key. Leave the other values to their defaults.
4. Select **Create**.
5. Copy the key URI.

#### The customer grants the service provider application access to the key vault

Assign the Azure RBAC role **Key Vault Crypto Service Encryption User** to the service provider's registered application so that it can access the key vault.

1. Navigate to your key vault and select **Access Control (IAM)** from the left pane.
2. Under **Grant access to this resource**, select **Add role assignment**.
3. Search for and select **Key Vault Crypto Service Encryption User**.
4. Under **Members**, select **User, group, or service principal**.
5. Select **Members** and search for the application name of the application you installed from the service provider.
6. Select **Review + Assign**.

Now you can configure customer-managed keys with the key vault URI and key.

To use Azure PowerShell to configure the client's tenant, install the latest [Az](https://www.powershellgallery.com/packages/Az) module. For more information about installing PowerShell, see [Install Azure PowerShell on Windows with PowerShellGet](/en-us/powershell/azure/install-azure-powershell).

* If you choose to use Azure PowerShell locally:
	+ [Install the Az PowerShell module](/en-us/powershell/azure/install-azure-powershell).
	+ Connect to your Azure account using the
	[Connect-AzAccount](/en-us/powershell/module/az.accounts/connect-azaccount) cmdlet.
* If you choose to use Azure Cloud Shell:
	+ See [Overview of Azure Cloud Shell](../cloud-shell/overview) for more information.

#### The customer signs into Azure

In Azure PowerShell, sign in to the customer's tenant and set the active subscription to the customer's subscription.

```
$customerTenantId="<customer-tenant-id>"
$customerSubscriptionId="<customer-subscription-id>"

# Sign in to Azure in the customer's tenant.
Connect-AzAccount -Tenant $customerTenantId
# Set the context to the customer's subscription.
Set-AzContext -Subscription $customerSubscriptionId

```

#### The customer installs the service provider application in the customer tenant

Once you receive the application ID of the service provider's multi-tenant application, install the application in your tenant, *Tenant2*, by creating a service principal.

Execute the following commands in the tenant where you plan to create the key vault.

```
$customerRgName="<customer-resource-group>"
$customerLocation="<location>"
$multiTenantAppId="<multi-tenant-app-id>" # appId value from Tenant1 

# Create a resource group in the customer's subscription.
New-AzResourceGroup -Location $customerLocation -ResourceGroupName $customerRgName

# Create the service principal with the registered app's application ID (client ID).
$servicePrincipal = New-AzADServicePrincipal -ApplicationId $multiTenantAppId

```

#### The customer creates a key vault

To create the key vault, the customer's account must be assigned the **Key Vault Contributor** role or another role that permits creation of a key vault.

```
$kvName="<key-vault>"

$kv = New-AzKeyVault -Location $customerLocation `
    -Name $kvName `
    -ResourceGroupName $customerRgName `
    -SubscriptionId $customerSubscriptionId `
    -EnablePurgeProtection `
    -EnableRbacAuthorization

```

#### The customer assigns Key Vault Crypto Officer role to a user account

Assign the **Key Vault Crypto Officer** role to a user account. This step ensures that the user can create the key vault and encryption keys. The example below assigns the role to the current signed-in user.

```
$currentUserObjectId = (Get-AzADUser -SignedIn).Id

New-AzRoleAssignment -RoleDefinitionName "Key Vault Crypto Officer" `
    -Scope $kv.ResourceId `
    -ObjectId $currentUserObjectId

```

#### The customer creates an encryption key

To create the encryption key, the user's account must be assigned the **Key Vault Crypto Officer** role or another role that permits creation of a key.

```
$keyName="<key-name>"

Add-AzKeyVaultKey -Name $keyName `
    -VaultName $kvName `
    -Destination software

```

#### The customer grants the service provider application access to the key vault

Assign the Azure RBAC role **Key Vault Crypto Service Encryption User** to the service provider's registered application, via the service principal that you created earlier, so that it can access the key vault.

```
New-AzRoleAssignment -RoleDefinitionName "Key Vault Crypto Service Encryption User" `
    -Scope $kv.ResourceId `
    -ObjectId $servicePrincipal.Id

```

Now you can configure customer-managed keys with the key vault URI and key.

* Use the Bash environment in [Azure Cloud Shell](/en-us/azure/cloud-shell/overview). For more information, see [Quickstart for Bash in Azure Cloud Shell](/en-us/azure/cloud-shell/quickstart).

[![](../reusable-content/azure-cli/media/hdi-launch-cloud-shell.png)](https://shell.azure.com)
* If you prefer to run CLI reference commands locally, [install](/en-us/cli/azure/install-azure-cli) the Azure CLI. If you're running on Windows or macOS, consider running Azure CLI in a Docker container. For more information, see [How to run the Azure CLI in a Docker container](/en-us/cli/azure/run-azure-cli-docker).

	+ If you're using a local installation, sign in to the Azure CLI by using the [az login](/en-us/cli/azure/reference-index#az-login) command. To finish the authentication process, follow the steps displayed in your terminal. For other sign-in options, see [Sign in with the Azure CLI](/en-us/cli/azure/authenticate-azure-cli).
	+ When you're prompted, install the Azure CLI extension on first use. For more information about extensions, see [Use extensions with the Azure CLI](/en-us/cli/azure/azure-cli-extensions-overview).
	+ Run [az version](/en-us/cli/azure/reference-index?#az-version) to find the version and dependent libraries that are installed. To upgrade to the latest version, run [az upgrade](/en-us/cli/azure/reference-index?#az-upgrade).

#### The customer signs in to Azure

Sign in to Azure to use Azure CLI.

```
az login

```

#### The customer installs the service provider application in the customer tenant

Once you receive the application ID of the service provider's multi-tenant application, install the application in your tenant *Tenant2* using the following command. Installing the application creates a service principal in your tenant.

Execute the following commands in the tenant where you plan to create the key vault.

```
# Create the service principal with the registered app's application ID (client ID)
multiTenantAppId="<multi-tenant-app-id>"
az ad sp create --id $multiTenantAppId --query id --out tsv

```

#### The customer creates a key vault

To create the key vault, the customer's account must be assigned the **Key Vault Contributor** role or another role that permits creation of a key vault.

```
customerSubscriptionId="<customer-subscription-id>"
customerRgName="<customer-resource-group>"
customerLocation="<location>"
kvName="<key-vault>"

az group create --location $customerLocation \
    --name $customerRgName

az keyvault create --name $kvName \
    --location $customerLocation \
    --resource-group $customerRgName \
    --subscription $customerSubscriptionId \
    --enable-purge-protection true \
    --enable-rbac-authorization true

```

#### The customer assigns Key Vault Crypto Officer role to a user account

This step ensures that you can create the key vault and encryption keys.

```
currentUserObjectId=$(az ad signed-in-user show --query id --output tsv)

kvResourceId=$(az keyvault show --resource-group $customerRgName \
    --name $kvName \
    --query id \
    --output tsv)

az role assignment create --role "Key Vault Crypto Officer" \
    --scope $kvResourceId \
    --assignee-object-id $currentUserObjectId

```

#### The customer creates an encryption key

To create the encryption key, the user's account must be assigned the **Key Vault Crypto Officer** role or another role that permits creation of a key.

```
keyName="<key-name>"
az keyvault key create --name $keyName --vault-name $kvName

```

#### The customer grants the service provider application access to the key vault

Assign the Azure RBAC role **Key Vault Crypto Service Encryption User** to the service provider's registered application, via the service principal that you created earlier, so that the registered application can access the key vault.

```
servicePrincipalId=$(az ad sp show --id $multiTenantAppId --query id --output tsv)

az role assignment create --role "Key Vault Crypto Service Encryption User" \
    --scope $kvResourceId \
    --assignee-object-id $servicePrincipalId

```

Now you can configure customer-managed keys with the key vault URI and key.

## Create a disk encryption set

Now that you've created your Azure Key Vault and performed the required Azure AD configurations, deploy a disk encryption set configured to work across tenants and associate it with a key in the key vault. You can do this using the Azure portal, Azure PowerShell, or Azure CLI. You can also use an [ARM template](#use-an-arm-template) or [REST API](#use-rest-api).

* [Portal](#tabpanel_1_azure-portal)
* [PowerShell](#tabpanel_1_azure-powershell)
* [Azure CLI](#tabpanel_1_azure-cli)

To use the Azure portal, sign in to the portal and follow these steps.

1. Select **+ Create a resource**, search for **Disk encryption set**, and select **Create > Disk encryption set**.
2. Under **Project details**, select the subscription and resource group in which to create the disk encryption set.
3. Under **Instance details**, provide a name for the disk encryption set.

![Screenshot showing how to enter the project and instance details to create a new disk encryption set.](media/disks-cross-tenant-customer-managed-keys/create-disk-encryption-set.png)
4. Select the **Region** in which to create the disk encryption set.
5. For **Encryption type**, select **Encryption at-rest with a customer-managed key**.
6. Under **Encryption key**, select the **Enter key from URI** radio button, and then enter the Key URI of the key created in the customer's tenant.
7. Under **User-assigned identity**, select **Select an identity**.
8. Select the user-assigned managed identity that you created previously in the ISV's tenant, and then select **Add**.
9. Under **Multi-tenant application**, select **Select an application**.
10. Select the multi-tenant registered application that you created previously in the ISV's tenant, and click **Select**.
11. Select **Review + create**.

To use Azure PowerShell, install the latest Az module or the Az.Storage module. For more information about installing PowerShell, see [Install Azure PowerShell on Windows with PowerShellGet](/en-us/powershell/azure/install-azure-powershell).

* If you choose to use Azure PowerShell locally:
	+ [Install the Az PowerShell module](/en-us/powershell/azure/install-azure-powershell).
	+ Connect to your Azure account using the
	[Connect-AzAccount](/en-us/powershell/module/az.accounts/connect-azaccount) cmdlet.
* If you choose to use Azure Cloud Shell:
	+ See [Overview of Azure Cloud Shell](../cloud-shell/overview) for more information.

In the script below, `-FederatedClientId` should be the application ID (client ID) of the multi-tenant application. You'll also need to provide the subscription ID, resource group name, and identity name.

```
$userAssignedIdentities = @{"/subscriptions/subscriptionId/resourceGroups/resourceGroupName/providers/Microsoft.ManagedIdentity/userAssignedIdentities/identityName" = @{}};

$config = New-AzDiskEncryptionSetConfig `
   -Location 'westcentralus' `
   -KeyUrl "https://vault1.vault.azure.net:443/keys/key1/mykey" `
   -IdentityType 'UserAssigned' `
   -RotationToLatestKeyVersionEnabled $True `
   -UserAssignedIdentity $userAssignedIdentities `
   -FederatedClientId "00000000-0000-0000-0000-000000000000" `
   $config `
   | New-AzDiskEncryptionSet -ResourceGroupName 'rg1' -Name 'enc1'

```

* Use the Bash environment in [Azure Cloud Shell](/en-us/azure/cloud-shell/overview). For more information, see [Quickstart for Bash in Azure Cloud Shell](/en-us/azure/cloud-shell/quickstart).

[![](../reusable-content/azure-cli/media/hdi-launch-cloud-shell.png)](https://shell.azure.com)
* If you prefer to run CLI reference commands locally, [install](/en-us/cli/azure/install-azure-cli) the Azure CLI. If you're running on Windows or macOS, consider running Azure CLI in a Docker container. For more information, see [How to run the Azure CLI in a Docker container](/en-us/cli/azure/run-azure-cli-docker).

	+ If you're using a local installation, sign in to the Azure CLI by using the [az login](/en-us/cli/azure/reference-index#az-login) command. To finish the authentication process, follow the steps displayed in your terminal. For other sign-in options, see [Sign in with the Azure CLI](/en-us/cli/azure/authenticate-azure-cli).
	+ When you're prompted, install the Azure CLI extension on first use. For more information about extensions, see [Use extensions with the Azure CLI](/en-us/cli/azure/azure-cli-extensions-overview).
	+ Run [az version](/en-us/cli/azure/reference-index?#az-version) to find the version and dependent libraries that are installed. To upgrade to the latest version, run [az upgrade](/en-us/cli/azure/reference-index?#az-upgrade).

In the command below, `myAssignedId` should be the resource ID of the user-assigned managed identity that you created earlier, and `myFederatedClientId` should be the application ID (client ID) of the multi-tenant application.

```
az disk-encryption-set create --resource-group MyResourceGroup --name MyDiskEncryptionSet --key-url MyKey --mi-user-assigned myAssignedId --federated-client-id myFederatedClientId --location westcentralus

```

### Use an ARM template

```
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "desname": {
      "defaultValue": "<Enter ISV disk encryption set name>",
      "type": "String"
    },
    "region": {
      "defaultValue": "WestCentralUS",
      "type": "String"
    },
    "userassignedmicmk": {
      "defaultValue": "/subscriptions/<Enter ISV Subscription Id>/resourceGroups/<Enter ISV resource group name>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<Enter ISV User Assigned Identity Name>",
      "type": "String"
    },
    "cmkfederatedclientId": {
      "defaultValue": "<Enter ISV Multi-Tenant App Id>",
      "type": "String"
    },
    "keyVaultURL": {
      "defaultValue": "<Enter Client Key URL>",
      "type": "String"
    },
    "encryptionType": {
      "defaultValue": "EncryptionAtRestWithCustomerKey",
      "type": "String"
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Compute/diskEncryptionSets",
      "apiVersion": "2021-12-01",
      "name": "[parameters('desname')]",
      "location": "[parameters('region')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[parameters('userassignedmicmk')]": {}
        }
      },
      "properties": {
        "activeKey": {
          "keyUrl": "[parameters('keyVaultURL')]"
        },
        "federatedClientId": "[parameters('cmkfederatedclientId')]",
        "encryptionType": "[parameters('encryptionType')]"
      }
    }
  ]
}

```

### Use REST API

Use bearer token as authorization header and application/JSON as content type in BODY. (Network tab, filter to management.azure while performing any ARM request on portal.)

```
PUT https://management.azure.com/subscriptions/<Enter ISV Subscription Id>/resourceGroups/<Enter ISV Resource Group Name>/providers/Microsoft.Compute/diskEncryptionSets/<Enter ISV Disk Encryption Set Name>?api-version=2021-12-01
Authorization: Bearer ...
Content-Type: application/json

{
  "name": "<Enter ISV disk encryption set name>",
  "id": "/subscriptions/<Enter ISV Subscription Id>/resourceGroups/<Enter ISV resource group name>/providers/Microsoft.Compute/diskEncryptionSets/<Enter ISV disk encryption set name>/",
  "type": "Microsoft.Compute/diskEncryptionSets",
  "location": "westcentralus",
  "identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
"/subscriptions/<Enter ISV Subscription Id>/resourceGroups/<Enter ISV resource group name>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<Enter ISV User Assigned Identity Name>
": {}
    }
  },
  "properties": {
    "activeKey": {
      "keyUrl": "<Enter Client Key URL>"
    },
    "encryptionType": "EncryptionAtRestWithCustomerKey",
    "federatedClientId": "<Enter ISV Multi-Tenant App Id>"
  }
}

```

## Next steps

See also:

* [Encrypt disks using customer-managed keys in Azure DevTest Labs](../devtest-labs/encrypt-disks-customer-managed-keys)
* [Use the Azure portal to enable server-side encryption with customer-managed keys for managed disks](disks-enable-customer-managed-keys-portal)

## Feedback

Submit and view feedback for

[This product](https://feedback.azure.com/d365community/forum/ec2f1827-be25-ec11-b6e6-000d3a4f0f1c)
This page

[View all page feedback](https://github.com/MicrosoftDocs/azure-docs/issues)

---
